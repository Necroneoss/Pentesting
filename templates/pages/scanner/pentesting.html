{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Resultados del Pentesting{% endblock title %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'dist/css/datatables_personalizados.css' %}">
<style>
    #network {
        width: 100%;
        height: 600px;
        border: 1px solid lightgray;
        margin-top: 20px;
    }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Pentesting - Resultados</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <!-- Tarjeta para la tabla -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h3 class="card-title">Resultados del Análisis de Subdominios</h3>
                        </div>
                        <div class="card-body">
                            <table id="tabledominio" class="table table-bordered table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th><i class="fas fa-network-wired"></i> Subdominio</th>
                                        <th><i class="fas fa-desktop"></i> IP</th>
                                        <th><i class="fas fa-link"></i> URL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in subdomains %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ entry.subdomain }}</td>
                                        <td>{{ entry.ip }}</td>
                                        <td><a href="{{ entry.url }}" target="_blank">{{ entry.url }}</a></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Tarjeta para el grafo -->
                    <div class="card mt-4">
                        <div class="card-header bg-secondary text-white">
                            <h3 class="card-title">Grafo de Subdominios</h3>
                        </div>
                        <div class="card-body">
                            <div id="network" style="width: 100%; height: 500px; border: 1px solid lightgray;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
</div>
{% endblock content %}

{% block extra_scripts %}
<script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="{% static 'dist/js/datatables_personalizados.js' %}"></script>
<script>
   $(function () {
  $("#tabledominio").DataTable({
    responsive: true,
    autoWidth: false,
    language: {
      search: "Buscar:",
      lengthMenu: "Mostrar _MENU_ registros",
      info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
      paginate: {
        first: "Primero",
        last: "Último",
        next: "Siguiente",
        previous: "Anterior",
      },
      zeroRecords: "No se encontraron resultados",
      infoEmpty: "Mostrando 0 a 0 de 0 registros",
      infoFiltered: "(filtrado de _MAX_ registros totales)",
    },
  });
});
    const nodes = {{ nodes|safe }};
    const edges = {{ edges|safe }};

    const container = document.getElementById('network');
    const data = {
        nodes: new vis.DataSet(nodes),
        edges: new vis.DataSet(edges),
    };

    const options = {
        nodes: {
            shape: 'dot',
            size: 15,
            font: { size: 14 },
            color: {
                background: '#97C2FC',
                border: '#2B7CE9',
            },
        },
        edges: {
            arrows: { to: { enabled: true, scaleFactor: 1 } },
        },
        interaction: {
            hover: true,
        },
        physics: {
            enabled: true,
        },
    };

    const network = new vis.Network(container, data, options);

    network.on('click', function (params) {
        if (params.nodes.length) {
            const nodeId = params.nodes[0];
            const node = data.nodes.get(nodeId);
            if (node.url) {
                window.open(node.url, '_blank');
            }
        }
    });
</script>

{% endblock extra_scripts %}
