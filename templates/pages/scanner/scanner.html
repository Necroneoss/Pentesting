{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Definición de Parámetros Iniciales {% endblock title %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'dist/css/datatables_personalizados.css' %}">
<style>
    .form-container {
        margin-top: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .btn {
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 14px;
    }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Definición de Parámetros Iniciales</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Inicio</a></li>
                        <li class="breadcrumb-item active">Parámetros Iniciales</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="form-container">
                        <form method="POST" action="{% url 'pentesting' %}">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="target_url">URL objetivo</label>
                                <input type="text" class="form-control" id="target_url" name="target_url" placeholder="Ingrese la URL, ej: emi.edu.bo" required>
                            </div>
                            <div class="form-group">
                                <label for="initial_options">Opciones Iniciales</label>
                                <select class="form-control" id="initial_options" name="initial_options">
                                    <option value="passive">Reconocimiento Pasivo</option>
                                    <option value="active">Reconocimiento Activo</option>
                                    
                                </select>
                            </div>
                            <div class="text-right">
                                <button type="button" id="start-pentesting" class="btn btn-success">
                                    <i class="fas fa-play"></i> Iniciar Pentesting
                                </button>
                            </div>
                            
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalLabel">Ejecución en Progreso</h5>
                </div>
                <div class="modal-body">
                    <div id="logContent" style="height: 400px; overflow-y: auto; background-color: #f9f9f9; padding: 10px; border: 1px solid #ddd;">
                        <p>Iniciando...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="next-button" type="button" class="btn btn-primary" style="display: none;" onclick="goToPentesting()">Siguiente</button>
                    <button id="stop-button" type="button" class="btn btn-secondary">Cerrar</button>

                </div>
                
            </div>
        </div>
    </div>
    <div class="modal fade" id="existingAnalysisModal" tabindex="-1" aria-labelledby="existingAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered d-flex justify-content-center" style="max-width: 40%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="existingAnalysisModalLabel">Análisis existente detectado</h5>
                </div>
                <div class="modal-body">
                    <p id="existingAnalysisMessage"></p>
                </div>
                <div class="modal-footer">
                    <button id="use-existing" type="button" class="btn btn-success">Usar resultado existente</button>
                    <button id="new-analysis" type="button" class="btn btn-warning">Hacer análisis de nuevo</button>
                </div>
            </div>
        </div>
    </div>
    
    
    
    
</div>
{% endblock content %}

{% block extra_scripts %}
<script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
<script src="{% static 'dist/js/datatables_personalizados.js' %}"></script>
<script>
document.getElementById('start-pentesting').addEventListener('click', function () {
    const targetUrl = document.getElementById('target_url').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!targetUrl.trim()) {
        alert("Por favor, ingrese un dominio válido.");
        return;
    }

    // Verificar si el JSON ya existe
    fetch('/run-command/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ target_url: targetUrl })
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    }).then(data => {
        if (data.exists) {
            // Mostrar el modal de opciones
            const existingAnalysisModal = new bootstrap.Modal(document.getElementById('existingAnalysisModal'));
            document.getElementById('existingAnalysisMessage').innerText = data.message;
            existingAnalysisModal.show();

            // Configurar acciones del modal
            document.getElementById('use-existing').onclick = function () {
                window.location.href = `/pentesting/?domain=${encodeURIComponent(targetUrl)}`;
            };

            document.getElementById('new-analysis').onclick = function () {
                existingAnalysisModal.hide(); // Cierra el modal inicial
                startNewAnalysis(targetUrl, csrfToken); // Inicia el análisis
            };
        } else {
            // Inicia un nuevo análisis directamente
            startNewAnalysis(targetUrl, csrfToken);
        }
    }).catch(error => {
        alert(`Error: ${error.message}`);
    });
});

function startNewAnalysis(targetUrl, csrfToken) {
    // Mostrar el modal de progreso
    const logModal = new bootstrap.Modal(document.getElementById('logModal'));
    logModal.show();

    // Limpiar el contenido del modal
    const logContent = document.getElementById('logContent');
    logContent.innerHTML = '<p>Iniciando...</p>';

    // Iniciar el análisis
    fetch('/run-command/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ target_url: targetUrl, new_analysis: true })  // Indica que es un nuevo análisis
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    }).then(data => {
        // Consultar los logs periódicamente
        const interval = setInterval(() => {
            fetch(`/get-logs/?log_file=${encodeURIComponent(data.log_file)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        clearInterval(interval);
                        logContent.innerHTML += `<p>${data.error}</p>`;
                        return;
                    }

                    logContent.innerHTML = data.logs.map(line => `<p>${line}</p>`).join('');
                    logContent.scrollTop = logContent.scrollHeight;

                    if (data.logs.some(line => line.includes("Finished OneForAll"))) {
                        clearInterval(interval);
                        logContent.innerHTML += '<p>Proceso completado. Puede continuar.</p>';
                        document.getElementById('next-button').style.display = 'inline-block';
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    logContent.innerHTML += `<p>Error al obtener los logs: ${error.message}</p>`;
                });
        }, 1000);
    }).catch(error => {
        logContent.innerHTML += `<p>Error al iniciar el proceso: ${error.message}</p>`;
    });
}
function goToPentesting() {
    const targetUrl = document.getElementById('target_url').value;
    window.location.href = `/pentesting/?domain=${encodeURIComponent(targetUrl)}`;
}
let interval = null; // Variable global para controlar el intervalo
document.addEventListener('DOMContentLoaded', function () {
    const stopButton = document.getElementById('stop-button');

    if (stopButton) {
        stopButton.addEventListener('click', function () {
            if (interval) {
                clearInterval(interval); // Detener el intervalo de consulta
            }

            const logContent = document.getElementById('logContent');
            logContent.innerHTML += '<p>Deteniendo el proceso...</p>';

            // Enviar solicitud al servidor para detener el proceso
            const targetUrl = document.getElementById('target_url').value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch('/stop-command/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ target_url: targetUrl })
            })
            .then(response => response.json())
            .then(data => {
                logContent.innerHTML += `<p>${data.message || data.error}</p>`;
                // Redirige a la página inicial (scanner.html)
                window.location.href = '/scanner/';
            })
            .catch(error => {
                logContent.innerHTML += `<p>Error al detener el proceso: ${error.message}</p>`;
                // Redirige de todas formas
                window.location.href = '/scanner/';
            });

            // Cerrar explícitamente el modal
            const logModal = bootstrap.Modal.getInstance(document.getElementById('logModal'));
            if (logModal) {
                logModal.hide(); // Cierra el modal
            }
        });
    } else {
        console.error('El botón "stop-button" no se encontró en el DOM.');
    }
});


</script>
{% endblock extra_scripts %}
